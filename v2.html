<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบส่งประวัติย่อและภาพประทับใจ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.27/dist/sweetalert2.min.css" rel="stylesheet">
    
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            font-family: 'K2D', sans-serif;
        }
        
        :root {
            --primary-green: #4CAF50;
            --light-green: #E8F5E8;
            --dark-green: #2E7D32;
            --border-green: #81C784;
        }
        
        body {
            background: linear-gradient(135deg, var(--light-green) 0%, #ffffff 100%);
            min-height: 100vh;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
        }
        
        .main-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            border: 2px solid var(--border-green);
            color: var(--dark-green);
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 10px 10px 0 0;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }
        
        .tab-content {
            background: white;
            border: 2px solid var(--border-green);
            border-radius: 0 15px 15px 15px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.1);
        }
        
        .form-control, .form-select {
            border: 2px solid var(--border-green);
            border-radius: 10px;
            padding: 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .card {
            border: 2px solid var(--border-green);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.1);
        }
        
        .card-header {
            background: var(--light-green);
            border-bottom: 2px solid var(--border-green);
            font-weight: 600;
            color: var(--dark-green);
        }
        
        .file-upload-area {
            border: 3px dashed var(--border-green);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            background: var(--light-green);
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-green);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: var(--light-green);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-green) 0%, var(--dark-green) 100%);
            border-radius: 15px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--border-green);
            margin: 0.25rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-green);
            border-top: 5px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-content {
            border-radius: 15px;
            border: 2px solid var(--border-green);
        }
        
        .modal-header {
            background: var(--light-green);
            border-bottom: 2px solid var(--border-green);
        }
        
        @media (max-width: 768px) {
            .header-section {
                padding: 1rem 0;
            }
            
            .logo-img {
                width: 40px;
                height: 40px;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner"></div>
            <p class="mt-3 text-success fw-bold">กำลังประมวลผล...</p>
        </div>
    </div>

    <div class="modal fade" id="pdpaModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>นโยบายความเป็นส่วนตัว (PDPA)</h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgP7650FTCSeNQU8DBnHv7w0lL7CxVLmv_vLJ4tE9vcPbILI9KNeTqAUnmPg6ELY-qyt5BLKSAuaQILMr6gyYiWqF8HToyRnYiks86ESHapld6XUGvp0wGfuGYyvra18zjhZN1afCwQ66ZvMxxaoS3ACz0zbe6d07GuYNWd7xFGPZZjI5tTLSiyOkifsqAh/s1600/sesapylogo.png" alt="Logo" class="logo-img">
                        <h4 class="mt-3 text-success">ยินดีต้อนรับสู่ระบบส่งประวัติย่อและภาพประทับใจ</h4>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>วัตถุประสงค์ของระบบ</h6>
                        <p>ระบบนี้จัดทำขึ้นเพื่อรวบรวมประวัติย่อและภาพประทับใจของข้าราชการครูและบุคลากรทางการศึกษา สังกัด สพม.พะเยา</p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-database me-2"></i>การเก็บรวบรวมข้อมูล</h6>
                        <ul class="mb-0">
                            <li>ข้อมูลส่วนบุคคล (ชื่อ-สกุล, ตำแหน่ง, โรงเรียน)</li>
                            <li>ข้อมูลติดต่อ (อีเมล, เบอร์โทรศัพท์)</li>
                            <li>ไฟล์ประวัติย่อและภาพประทับใจ</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-success">
                        <h6><i class="fas fa-lock me-2"></i>การคุ้มครองข้อมูล</h6>
                        <p>ข้อมูลของท่านจะถูกเก็บรักษาอย่างปลอดภัยและใช้เพื่อวัตถุประสงค์ทางการศึกษาเท่านั้น</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="window.close()">
                        <i class="fas fa-times me-2"></i>ยกเลิก
                    </button>
                    <button type="button" class="btn btn-primary" onclick="acceptPDPA()">
                        <i class="fas fa-check me-2"></i>ยินยอมเข้าระบบ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="header-section">
        <div class="container">
            <div class="logo-container justify-content-center">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgP7650FTCSeNQU8DBnHv7w0lL7CxVLmv_vLJ4tE9vcPbILI9KNeTqAUnmPg6ELY-qyt5BLKSAuaQILMr6gyYiWqF8HToyRnYiks86ESHapld6XUGvp0wGfuGYyvra18zjhZN1afCwQ66ZvMxxaoS3ACz0zbe6d07GuYNWd7xFGPZZjI5tTLSiyOkifsqAh/s1600/sesapylogo.png" alt="Logo" class="logo-img">
                <div>
                    <h2 class="mb-0">ระบบส่งประวัติย่อและภาพประทับใจ</h2>
                    <p class="mb-0 opacity-75">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษาพะเยา</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                    <i class="fas fa-upload me-2"></i>เพิ่มข้อมูล
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>สถิติและ Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab">
                    <i class="fas fa-cogs me-2"></i>จัดการข้อมูล
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <form id="uploadForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i>วันที่ส่ง</label>
                            <input type="date" class="form-control" id="submitDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user me-2"></i>ชื่อ-สกุล</label>
                            <input type="text" class="form-control" id="fullName" placeholder="กรอกชื่อ-สกุล" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-briefcase me-2"></i>ตำแหน่ง</label>
                            <select class="form-select" id="position" required>
                                <option value="">เลือกตำแหน่ง</option>
                                <option value="ครู">ครู</option>
                                <option value="หัวหน้าฝ่าย">หัวหน้าฝ่าย</option>
                                <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                                <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                                <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-star me-2"></i>วิทยฐานะ</label>
                            <select class="form-select" id="academicLevel" required>
                                <option value="">เลือกวิทยฐานะ</option>
                                <option value="ชำนาญการ">ชำนาญการ</option>
                                <option value="ชำนาญการพิเศษ">ชำนาญการพิเศษ</option>
                                <option value="เชี่ยวชาญ">เชี่ยวชาญ</option>
                                <option value="เชี่ยวชาญพิเศษ">เชี่ยวชาญพิเศษ</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-school me-2"></i>โรงเรียน</label>
                            <select class="form-select" id="school" required>
                                <option value="">เลือกโรงเรียน</option>
                                <option value="โรงเรียนพะเยาพิทยาคม">โรงเรียนพะเยาพิทยาคม</option>
                                <option value="โรงเรียนเชียงคำวิทยาคม">โรงเรียนเชียงคำวิทยาคม</option>
                                <option value="โรงเรียนดอกคำใต้วิทยาคม">โรงเรียนดอกคำใต้วิทยาคม</option>
                                <option value="โรงเรียนเชียงมวนวิทยาคม">โรงเรียนเชียงมวนวิทยาคม</option>
                                <option value="โรงเรียนปงวิทยาคม">โรงเรียนปงวิทยาคม</option>
                                <option value="โรงเรียนแม่ใสวิทยาคม">โรงเรียนแม่ใสวิทยาคม</option>
                                <option value="โรงเรียนภูซางวิทยาคม">โรงเรียนภูซางวิทยาคม</option>
                                <option value="โรงเรียนภูกามยาววิทยาคม">โรงเรียนภูกามยาววิทยาคม</option>
                                <option value="โรงเรียนสันป่าตองวิทยาคม">โรงเรียนสันป่าตองวิทยาคม</option>
                                <option value="โรงเรียนเวียงพะเยาวิทยาคม">โรงเรียนเวียงพะเยาวิทยาคม</option>
                                <option value="โรงเรียนแม่ลาววิทยาคม">โรงเรียนแม่ลาววิทยาคม</option>
                                <option value="โรงเรียนจุนวิทยาคม">โรงเรียนจุนวิทยาคม</option>
                                <option value="โรงเรียนแม่ใจวิทยาคม">โรงเรียนแม่ใจวิทยาคม</option>
                                <option value="โรงเรียนแม่ต๋ำวิทยาคม">โรงเรียนแม่ต๋ำวิทยาคม</option>
                                <option value="โรงเรียนแม่ใจ (ธีรวิทย์)">โรงเรียนแม่ใจ (ธีรวิทย์)</option>
                                <option value="โรงเรียนเทิงวิทยาคม">โรงเรียนเทิงวิทยาคม</option>
                                <option value="โรงเรียนแม่ใสวิทยาคม">โรงเรียนแม่ใสวิทยาคม</option>
                                <option value="โรงเรียนแม่ลาววิทยาคม">โรงเรียนแม่ลาววิทยาคม</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-envelope me-2"></i>อีเมล</label>
                            <input type="email" class="form-control" id="email" placeholder="example@email.com" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-phone me-2"></i>เบอร์โทรศัพท์</label>
                            <input type="tel" class="form-control" id="phone" placeholder="0812345678" pattern="[0-9]{10}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-check-circle me-2"></i>สถานะการตรวจสอบ</label>
                            <select class="form-select" id="status" required>
                                <option value="ยังไม่ได้ตรวจสอบ">ยังไม่ได้ตรวจสอบ</option>
                                <option value="ตรวจสอบแล้ว">ตรวจสอบแล้ว</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-comment me-2"></i>ข้อความเพิ่มเติม</label>
                        <textarea class="form-control" id="additionalMessage" rows="3" placeholder="กรอกข้อความเพิ่มเติม (ถ้ามี)"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-file-pdf me-2"></i>ไฟล์ประวัติย่อ
                                </div>
                                <div class="card-body">
                                    <div class="file-upload-area" onclick="document.getElementById('resumeFile').click()">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-success mb-3"></i>
                                        <p>คลิกเพื่อเลือกไฟล์ประวัติย่อ</p>
                                        <small class="text-muted">รองรับ: PDF, DOC, DOCX, XLS, XLSX</small>
                                    </div>
                                    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,.xls,.xlsx" style="display: none;">
                                    <div id="resumePreview" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-images me-2"></i>ภาพประทับใจ (สูงสุด 15 รูป)
                                </div>
                                <div class="card-body">
                                    <div class="file-upload-area" onclick="document.getElementById('imageFiles').click()">
                                        <i class="fas fa-camera fa-3x text-success mb-3"></i>
                                        <p>คลิกเพื่อเลือกภาพประทับใจ</p>
                                        <small class="text-muted">รองรับ: JPG, JPEG, PNG, PDF</small>
                                    </div>
                                    <input type="file" id="imageFiles" accept=".jpg,.jpeg,.png,.pdf" multiple style="display: none;">
                                    <div id="imagePreview" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>ส่งข้อมูล
                        </button>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="dashboard" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="stats-card">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <div class="stats-number" id="totalUsers">0</div>
                            <p>จำนวนผู้อัปโหลด</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="stats-card">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <div class="stats-number" id="totalFiles">0</div>
                            <p>จำนวนไฟล์ประวัติ</p>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="stats-card">
                            <i class="fas fa-images fa-3x mb-3"></i>
                            <div class="stats-number" id="totalImages">0</div>
                            <p>จำนวนภาพประทับใจ</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i>สถิติตามโรงเรียน
                            </div>
                            <div class="card-body">
                                <canvas id="schoolChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-pie me-2"></i>สถิติตามสถานะ
                            </div>
                            <div class="card-body">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="dashboardSearch" placeholder="ค้นหาข้อมูล...">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>ข้อมูลล่าสุด (5 รายการ)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="recentDataTable">
                                <thead>
                                    <tr>
                                        <th>ชื่อ-สกุล</th>
                                        <th>โรงเรียน</th>
                                        <th>ภาพตัวอย่าง</th>
                                        <th>สถานะ</th>
                                        <th>วันที่ส่ง</th>
                                    </tr>
                                </thead>
                                <tbody id="recentDataBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="manage" role="tabpanel">
                <div class="modal fade" id="adminModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-lock me-2"></i>ยืนยันรหัสผ่านผู้ดูแล</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">รหัสผ่าน</label>
                                    <input type="password" class="form-control" id="adminPassword" placeholder="กรอกรหัสผ่านผู้ดูแล">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                                <button type="button" class="btn btn-primary" onclick="verifyAdmin()">ยืนยัน</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="editModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>แก้ไขข้อมูล</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editForm">
                                    <input type="hidden" id="editRowId">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">ชื่อ-สกุล</label>
                                            <input type="text" class="form-control" id="editFullName">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">โรงเรียน</label>
                                            <select class="form-select" id="editSchool">
                                                </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">ตำแหน่ง</label>
                                            <select class="form-select" id="editPosition">
                                                </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">สถานะ</label>
                                            <select class="form-select" id="editStatus">
                                                <option value="ยังไม่ได้ตรวจสอบ">ยังไม่ได้ตรวจสอบ</option>
                                                <option value="ตรวจสอบแล้ว">ตรวจสอบแล้ว</option>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                                <button type="button" class="btn btn-primary" onclick="updateData()">บันทึก</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <button class="btn btn-success me-2" onclick="refreshData()">
                            <i class="fas fa-sync me-2"></i>รีเฟรชข้อมูล
                        </button>
                        <button class="btn btn-info" onclick="printReport()">
                            <i class="fas fa-print me-2"></i>พิมพ์รายงาน
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-table me-2"></i>จัดการข้อมูลทั้งหมด
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>ลำดับ</th>
                                        <th>วันที่</th>
                                        <th>ชื่อ-สกุล</th>
                                        <th>โรงเรียน</th>
                                        <th>ตำแหน่ง</th>
                                        <th>สถานะ</th>
                                        <th>ภาพตัวอย่าง</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.27/dist/sweetalert2.all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // Google Apps Script host URL (replace with your deployed web app URL)
        const SCRIPT_URL = "YOUR_DEPLOYED_APPS_SCRIPT_URL"; // Replace with your deployed Apps Script URL

        // --- PDPA Modal Handling ---
        function showPdpaModal() {
            const pdpaAccepted = localStorage.getItem('pdpaAccepted');
            if (!pdpaAccepted) {
                const pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
                pdpaModal.show();
            }
        }

        function acceptPDPA() {
            localStorage.setItem('pdpaAccepted', 'true');
            bootstrap.Modal.getInstance(document.getElementById('pdpaModal')).hide();
        }

        // --- Form Submission ---
        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading(true);

            const submitDate = document.getElementById('submitDate').value;
            const fullName = document.getElementById('fullName').value;
            const position = document.getElementById('position').value;
            const academicLevel = document.getElementById('academicLevel').value;
            const school = document.getElementById('school').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const status = document.getElementById('status').value;
            const additionalMessage = document.getElementById('additionalMessage').value;
            
            const resumeFile = document.getElementById('resumeFile').files[0];
            const imageFiles = Array.from(document.getElementById('imageFiles').files);

            // Validate file types and limits
            if (resumeFile && !['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'].includes(resumeFile.type)) {
                Swal.fire('ข้อผิดพลาด', 'ไฟล์ประวัติย่อต้องเป็น PDF, DOC, DOCX, XLS, XLSX เท่านั้น', 'error');
                showLoading(false);
                return;
            }

            if (imageFiles.length > 15) {
                Swal.fire('ข้อผิดพลาด', 'อัปโหลดภาพประทับใจได้สูงสุด 15 รูป', 'error');
                showLoading(false);
                return;
            }
            for (const file of imageFiles) {
                if (!['image/jpeg', 'image/png', 'application/pdf'].includes(file.type)) {
                    Swal.fire('ข้อผิดพลาด', 'ภาพประทับใจต้องเป็น JPG, JPEG, PNG, PDF เท่านั้น', 'error');
                    showLoading(false);
                    return;
                }
            }
            
            const readerPromises = [];
            
            // Read resume file
            let encodedResumeFile = null;
            if (resumeFile) {
                readerPromises.push(new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        encodedResumeFile = {
                            name: resumeFile.name,
                            type: resumeFile.type,
                            data: e.target.result.split(',')[1]
                        };
                        resolve();
                    };
                    reader.readAsDataURL(resumeFile);
                }));
            }

            // Read image files
            const encodedImageFiles = [];
            for (const file of imageFiles) {
                readerPromises.push(new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        encodedImageFiles.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result.split(',')[1]
                        });
                        resolve();
                    };
                    reader.readAsDataURL(file);
                }));
            }

            await Promise.all(readerPromises);

            const formData = {
                submitDate,
                fullName,
                position,
                academicLevel,
                school,
                email,
                phone,
                status,
                additionalMessage,
                resumeFile: encodedResumeFile,
                imageFiles: encodedImageFiles
            };

            google.script.run
                .withSuccessHandler(function(response) {
                    showLoading(false);
                    if (response.success) {
                        Swal.fire('สำเร็จ', response.message, 'success');
                        document.getElementById('uploadForm').reset();
                        document.getElementById('resumePreview').innerHTML = '';
                        document.getElementById('imagePreview').innerHTML = '';
                        // Refresh data after successful submission
                        loadRecentData();
                        loadAllData();
                        updateStatistics();
                    } else {
                        Swal.fire('ข้อผิดพลาด', response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    console.error('Error submitting form:', error);
                    Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการส่งข้อมูล: ' + error.message, 'error');
                })
                .doPost({ action: 'submit', data: formData });
        });

        // --- File Preview ---
        document.getElementById('resumeFile').addEventListener('change', function(event) {
            const preview = document.getElementById('resumePreview');
            preview.innerHTML = '';
            const file = event.target.files[0];
            if (file) {
                preview.innerHTML = `<p class="text-success mt-2">✅ ไฟล์: ${file.name}</p>`;
            }
        });

        document.getElementById('imageFiles').addEventListener('change', function(event) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            const files = event.target.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.innerHTML += `<img src="${e.target.result}" class="preview-image" alt="Preview">`;
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        preview.innerHTML += `<div class="preview-image d-flex align-items-center justify-content-center bg-light text-danger" style="font-size: 2rem;"><i class="fas fa-file-pdf"></i></div>`;
                    }
                });
            }
        });

        // --- Data Loading and Display ---
        let allTableData = [];
        let dataTable; // For DataTables instance

        function loadAllData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(response) {
                    showLoading(false);
                    if (response.success) {
                        allTableData = response.data.map(item => ({
                            ...item,
                            submitDate: new Date(item.submitDate).toLocaleDateString('th-TH'),
                            // Ensure image is treated as HTML for DataTables
                            imageHtml: item.firstImage ? `<img src="${item.firstImage}" class="preview-image" alt="ภาพตัวอย่าง">` : 'ไม่มีภาพ'
                        }));
                        renderDataTable(allTableData);
                    } else {
                        Swal.fire('ข้อผิดพลาด', response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    console.error('Error loading all data:', error);
                    Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการดึงข้อมูลทั้งหมด: ' + error.message, 'error');
                })
                .doGet({ action: 'getData' });
        }

        function renderDataTable(data) {
            if (dataTable) {
                dataTable.destroy();
                $('#dataTable tbody').empty();
            }
            dataTable = $('#dataTable').DataTable({
                data: data,
                columns: [
                    { data: 'rowIndex', render: function(data, type, row, meta) { return meta.row + 1; } },
                    { data: 'submitDate' },
                    { data: 'fullName' },
                    { data: 'school' },
                    { data: 'position' },
                    { data: 'status' },
                    { data: 'imageHtml', orderable: false, searchable: false }, // Use the pre-rendered HTML
                    {
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <button class="btn btn-warning btn-sm me-1" onclick="openEditModal(${row.rowIndex})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteData(${row.rowIndex})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        },
                        orderable: false,
                        searchable: false
                    }
                ],
                responsive: true,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/th.json"
                }
            });
        }

        function loadRecentData() {
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(response) {
                    showLoading(false);
                    if (response.success) {
                        const recentDataBody = document.getElementById('recentDataBody');
                        recentDataBody.innerHTML = '';
                        const latest5 = response.data.slice(-5).reverse(); // Get latest 5 and reverse to show newest first

                        if (latest5.length === 0) {
                            recentDataBody.innerHTML = '<tr><td colspan="5" class="text-center">ไม่มีข้อมูลล่าสุด</td></tr>';
                            return;
                        }

                        latest5.forEach(item => {
                            const row = recentDataBody.insertRow();
                            row.insertCell().textContent = item.fullName;
                            row.insertCell().textContent = item.school;
                            const imageCell = row.insertCell();
                            if (item.firstImage) {
                                imageCell.innerHTML = `<img src="${item.firstImage}" class="preview-image" alt="ภาพตัวอย่าง">`;
                            } else {
                                imageCell.textContent = 'ไม่มีภาพ';
                            }
                            row.insertCell().textContent = item.status;
                            row.insertCell().textContent = new Date(item.submitDate).toLocaleDateString('th-TH');
                        });
                    } else {
                        Swal.fire('ข้อผิดพลาด', response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    console.error('Error loading recent data:', error);
                    Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการดึงข้อมูลล่าสุด: ' + error.message, 'error');
                })
                .doGet({ action: 'getData' });
        }

        // --- Statistics and Charts ---
        function updateStatistics() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const data = response.data;
                        document.getElementById('totalUsers').textContent = new Set(data.map(item => item.fullName)).size;
                        document.getElementById('totalFiles').textContent = data.filter(item => item.resumeFile).length;
                        document.getElementById('totalImages').textContent = data.reduce((sum, item) => sum + (item.imageCount || 0), 0);
                        
                        // Update Charts
                        updateSchoolChart(data);
                        updateStatusChart(data);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error updating statistics:', error);
                })
                .doGet({ action: 'getData' });
        }

        let schoolChartInstance;
        function updateSchoolChart(data) {
            const schoolCounts = {};
            data.forEach(item => {
                schoolCounts[item.school] = (schoolCounts[item.school] || 0) + 1;
            });
            const labels = Object.keys(schoolCounts);
            const counts = Object.values(schoolCounts);

            const ctx = document.getElementById('schoolChart').getContext('2d');
            if (schoolChartInstance) {
                schoolChartInstance.destroy();
            }
            schoolChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'จำนวนผู้ส่ง',
                        data: counts,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'จำนวนผู้ส่ง'
                            }
                        }
                    }
                }
            });
        }

        let statusChartInstance;
        function updateStatusChart(data) {
            const statusCounts = {};
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            const labels = Object.keys(statusCounts);
            const counts = Object.values(statusCounts);

            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChartInstance) {
                statusChartInstance.destroy();
            }
            statusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)', // ยังไม่ได้ตรวจสอบ
                            'rgba(54, 162, 235, 0.6)'  // ตรวจสอบแล้ว
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'สถิติตามสถานะการตรวจสอบ'
                        }
                    }
                }
            });
        }

        // --- Admin Functions ---
        const ADMIN_PASSWORD = "your_admin_password"; // TODO: Replace with a secure password or a more robust authentication mechanism

        $('#manage-tab').on('shown.bs.tab', function (e) {
            const adminModal = new bootstrap.Modal(document.getElementById('adminModal'));
            adminModal.show();
        });

        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
                loadAllData(); // Load data only after successful authentication
                $('#adminPassword').val(''); // Clear password field
            } else {
                Swal.fire('ผิดพลาด', 'รหัสผ่านผู้ดูแลไม่ถูกต้อง', 'error');
            }
        }

        function openEditModal(rowIndex) {
            const rowData = allTableData[rowIndex];
            if (!rowData) {
                Swal.fire('ข้อผิดพลาด', 'ไม่พบข้อมูลสำหรับแก้ไข', 'error');
                return;
            }

            document.getElementById('editRowId').value = rowIndex;
            document.getElementById('editFullName').value = rowData.fullName;
            document.getElementById('editStatus').value = rowData.status;

            // Populate school dropdown
            const editSchoolSelect = document.getElementById('editSchool');
            editSchoolSelect.innerHTML = '<option value="">เลือกโรงเรียน</option>';
            const schools = ["โรงเรียนพะเยาพิทยาคม", "โรงเรียนเชียงคำวิทยาคม", "โรงเรียนดอกคำใต้วิทยาคม", "โรงเรียนเชียงมวนวิทยาคม", "โรงเรียนปงวิทยาคม", "โรงเรียนแม่ใสวิทยาคม", "โรงเรียนภูซางวิทยาคม", "โรงเรียนภูกามยาววิทยาคม", "โรงเรียนสันป่าตองวิทยาคม", "โรงเรียนเวียงพะเยาวิทยาคม", "โรงเรียนแม่ลาววิทยาคม", "โรงเรียนจุนวิทยาคม", "โรงเรียนแม่ใจวิทยาคม", "โรงเรียนแม่ต๋ำวิทยาคม", "โรงเรียนแม่ใจ (ธีรวิทย์)", "โรงเรียนเทิงวิทยาคม", "โรงเรียนแม่ใสวิทยาคม", "โรงเรียนแม่ลาววิทยาคม"];
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                editSchoolSelect.appendChild(option);
            });
            editSchoolSelect.value = rowData.school;

            // Populate position dropdown
            const editPositionSelect = document.getElementById('editPosition');
            editPositionSelect.innerHTML = '<option value="">เลือกตำแหน่ง</option>';
            const positions = ["ครู", "หัวหน้าฝ่าย", "รองผู้อำนวยการ", "ผู้อำนวยการ", "ครูผู้ช่วย"];
            positions.forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                option.textContent = position;
                editPositionSelect.appendChild(option);
            });
            editPositionSelect.value = rowData.position;
            
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        function updateData() {
            showLoading(true);
            const rowIndex = document.getElementById('editRowId').value;
            const updatedData = {
                fullName: document.getElementById('editFullName').value,
                school: document.getElementById('editSchool').value,
                position: document.getElementById('editPosition').value,
                status: document.getElementById('editStatus').value
            };

            google.script.run
                .withSuccessHandler(function(response) {
                    showLoading(false);
                    if (response.success) {
                        Swal.fire('สำเร็จ', response.message, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        loadAllData(); // Reload all data after update
                        loadRecentData();
                        updateStatistics();
                    } else {
                        Swal.fire('ข้อผิดพลาด', response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    console.error('Error updating data:', error);
                    Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล: ' + error.message, 'error');
                })
                .doPost({ action: 'update', index: rowIndex, data: updatedData });
        }

        function deleteData(rowIndex) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "คุณต้องการลบข้อมูลนี้ใช่หรือไม่?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading(true);
                    google.script.run
                        .withSuccessHandler(function(response) {
                            showLoading(false);
                            if (response.success) {
                                Swal.fire('ลบแล้ว!', response.message, 'success');
                                loadAllData(); // Reload all data after delete
                                loadRecentData();
                                updateStatistics();
                            } else {
                                Swal.fire('ข้อผิดพลาด', response.message, 'error');
                            }
                        })
                        .withFailureHandler(function(error) {
                            showLoading(false);
                            console.error('Error deleting data:', error);
                            Swal.fire('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message, 'error');
                        })
                        .doPost({ action: 'delete', index: rowIndex });
                }
            });
        }

        function refreshData() {
            loadAllData();
            loadRecentData();
            updateStatistics();
            Swal.fire('รีเฟรชข้อมูล', 'ข้อมูลอัปเดตล่าสุดแล้ว', 'success');
        }

        function printReport() {
            const printContent = `
                <html>
                <head>
                    <title>รายงานข้อมูล</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { font-family: 'K2D', sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .preview-image { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h2 class="text-center mb-4">รายงานข้อมูลทั้งหมด</h2>
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>ลำดับ</th>
                                <th>วันที่</th>
                                <th>ชื่อ-สกุล</th>
                                <th>โรงเรียน</th>
                                <th>ตำแหน่ง</th>
                                <th>สถานะ</th>
                                <th>ภาพตัวอย่าง</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allTableData.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.submitDate}</td>
                                    <td>${item.fullName}</td>
                                    <td>${item.school}</td>
                                    <td>${item.position}</td>
                                    <td>${item.status}</td>
                                    <td>${item.firstImage ? `<img src="${item.firstImage}" class="preview-image" alt="ภาพตัวอย่าง">` : 'ไม่มีภาพ'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // Initial loads on page load
        document.addEventListener('DOMContentLoaded', function() {
            showPdpaModal(); // Show PDPA modal on load
            loadRecentData();
            updateStatistics();

            // Handle tab changes
            const mainTabs = document.getElementById('mainTabs');
            mainTabs.addEventListener('shown.bs.tab', function (event) {
                if (event.target.id === 'dashboard-tab') {
                    loadRecentData();
                    updateStatistics();
                } else if (event.target.id === 'manage-tab') {
                    // DataTables will be loaded after admin verification
                }
            });

            // Dashboard Search functionality (client-side filtering)
            document.getElementById('dashboardSearch').addEventListener('keyup', function() {
                const searchValue = this.value.toLowerCase();
                const recentRows = document.querySelectorAll('#recentDataBody tr');
                recentRows.forEach(row => {
                    const textContent = row.textContent.toLowerCase();
                    if (textContent.includes(searchValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
