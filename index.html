<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบส่งข้อมูลและไฟล์งาน</title>
  <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2E7D32;
      --secondary-color: #E8F5E8;
      --white: #FFFFFF;
      --text-color: #333333;
      --border-color: #2E7D32;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'K2D', sans-serif;
    }
    
    body {
      background-color: var(--secondary-color);
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: 2px solid var(--border-color);
      text-align: center;
    }
    
    .logo {
      width: 100px;
      height: auto;
      margin-bottom: 10px;
    }
    
    h1 {
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background-color: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--border-color);
    }
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab:hover {
      background-color: var(--secondary-color);
    }
    
    .tab.active {
      background-color: var(--primary-color);
      color: var(--white);
    }
    
    .tab-content {
      display: none;
      background-color: var(--white);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--border-color);
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .btn:hover {
      background-color: #1B5E20;
    }
    
    .file-upload {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .file-upload.active {
      border-color: var(--primary-color);
    }
    
    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .file-preview-item {
      width: 100px;
      height: 100px;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .file-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .file-preview-item .remove-file {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .progress-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 5px;
      margin: 15px 0;
      display: none;
    }
    
    .progress-bar {
      height: 20px;
      background-color: var(--primary-color);
      border-radius: 5px;
      width: 0%;
      transition: width 0.3s;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 20px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--border-color);
      text-align: center;
    }
    
    .stat-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .stat-card .stat-value {
      font-size: 24px;
      font-weight: bold;
    }
    
    .chart-container {
      background-color: var(--white);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border: 2px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    table, th, td {
      border: 1px solid #ddd;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
    }
    
    th {
      background-color: var(--primary-color);
      color: var(--white);
    }
    
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    
    .action-btn {
      padding: 5px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .edit-btn {
      background-color: #2196F3;
      color: white;
    }
    
    .delete-btn {
      background-color: #f44336;
      color: white;
    }
    
    .thumbnail-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 5px;
    }
    
    .pdpa-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .pdpa-content {
      background-color: var(--white);
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid var(--border-color);
    }
    
    .pdpa-content h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .pdpa-content p {
      margin-bottom: 15px;
    }
    
    .pdpa-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        padding: 10px;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- PDPA Modal -->
  <div class="pdpa-modal" id="pdpaModal">
    <div class="pdpa-content" >
      <center>
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgP7650FTCSeNQU8DBnHv7w0lL7CxVLmv_vLJ4tE9vcPbILI9KNeTqAUnmPg6ELY-qyt5BLKSAuaQILMr6gyYiWqF8HToyRnYiks86ESHapld6XUGvp0wGfuGYyvra18zjhZN1afCwQ66ZvMxxaoS3ACz0zbe6d07GuYNWd7xFGPZZjI5tTLSiyOkifsqAh/s1600/sesapylogo.png" alt="Logo" class="logo">
      </center>
      <h2>นโยบายความเป็นส่วนตัว</h2>
      <p>ระบบส่งข้อมูลประวัติย่อ และรูปประทับใจ นี้ให้ความสำคัญกับการคุ้มครองข้อมูลส่วนบุคคลของคุณตามพระราชบัญญัติคุ้มครองข้อมูลส่วนบุคคล พ.ศ. 2562 (PDPA)</p>
      <p>เราเก็บรวบรวมข้อมูลส่วนบุคคลของคุณเพื่อวัตถุประสงค์ในการให้บริการและพัฒนาระบบเท่านั้น โดยจะไม่เปิดเผยข้อมูลให้กับบุคคลที่สามโดยไม่ได้รับความยินยอมจากคุณ</p>
      <p>ข้อมูลที่เรารวบรวมอาจรวมถึง:</p>
      <ul>
        <li>ชื่อ-นามสกุล</li>
        <li>ตำแหน่งงาน</li>
        <li>ข้อมูลการติดต่อ (อีเมล, เบอร์โทรศัพท์)</li>
        <li>ไฟล์งานที่คุณอัปโหลด</li>
      </ul>
      <p>คุณมีสิทธิ์ขอเข้าถึง แก้ไข ลบ หรือเพิกถอนความยินยอมในการใช้ข้อมูลของคุณได้ทุกเมื่อ</p>
      <div class="pdpa-buttons">
        <button class="btn" id="pdpaAgree">ยินยอม</button>
        <button class="btn" style="background-color: #f44336;" id="pdpaDisagree">ยกเลิก</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="container">
    <header>
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgP7650FTCSeNQU8DBnHv7w0lL7CxVLmv_vLJ4tE9vcPbILI9KNeTqAUnmPg6ELY-qyt5BLKSAuaQILMr6gyYiWqF8HToyRnYiks86ESHapld6XUGvp0wGfuGYyvra18zjhZN1afCwQ66ZvMxxaoS3ACz0zbe6d07GuYNWd7xFGPZZjI5tTLSiyOkifsqAh/s1600/sesapylogo.png" alt="Logo" class="logo"> 
      <h1>ระบบส่งข้อมูลประวัติย่อ และรูปประทับใจ</h1>
    </header>
    
    <div class="tabs">
      <div class="tab active" data-tab="tab1">เพิ่มข้อมูล 📝</div>
      <div class="tab" data-tab="tab2">สถิติการอัปโหลด 📊</div>
      <div class="tab" data-tab="tab3">จัดการข้อมูล 🛠️</div>
      <div class="tab" data-tab="tab4">ตรวจสอบข้อมูล 🖼️</div>      
    </div>
    
    <!-- Tab 1: เพิ่มข้อมูล -->
    <div class="tab-content active" id="tab1">
      <form id="uploadForm">
        <div class="form-group">
          <label for="submissionDate">วัน เดือน ปี ที่ส่ง</label>
          <input type="date" id="submissionDate" name="submissionDate" required>
        </div>
        
        <div class="form-group">
          <label for="fullName">ชื่อ-สกุล</label>
          <input type="text" id="fullName" name="fullName" required>
        </div>
        
        <div class="form-group">
          <label for="position">ตำแหน่ง</label>
          <select id="position" name="position" required>
            <option value="">-- กรุณาเลือกตำแหน่ง --</option>
            <option value="ครู">ครู</option>
            <option value="ผู้อำนวยการโรงเรียน">ผู้อำนวยการโรงเรียน</option>
            <option value="รองผู้อำนวยการโรงเรียน">รองผู้อำนวยการโรงเรียน</option>    
          </select>
        </div>
        
        <div class="form-group">
          <label for="academicRank">วิทยฐานะ</label>
          <select id="academicRank" name="academicRank">
            <option value="">-- กรุณาเลือกวิทยฐานะ --</option>
            <option value="ชำนาญการ">ชำนาญการ</option>
            <option value="ชำนาญการพิเศษ">ชำนาญการพิเศษ</option>
            <option value="เชี่ยวชาญ">เชี่ยวชาญ</option>
            <option value="เชี่ยวชาญพิเศษ">เชี่ยวชาญพิเศษ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="school">โรงเรียน</label>
          <select id="school" name="school" required>
            <option value="">-- กรุณาเลือกโรงเรียน --</option>
            <option value="โรงเรียนพะเยาพิทยาคม">โรงเรียนพะเยาพิทยาคม</option>
<option value="โรงเรียนฟากกว๊านวิทยาคม">โรงเรียนฟากกว๊านวิทยาคม</option>
<option value="โรงเรียนพะเยาประสาธน์วิทย์">โรงเรียนพะเยาประสาธน์วิทย์</option>
<option value="โรงเรียนจุนวิทยาคม">โรงเรียนจุนวิทยาคม</option>
<option value="โรงเรียนพญาลอวิทยาคม">โรงเรียนพญาลอวิทยาคม</option>
<option value="โรงเรียนเชียงคำวิทยาคม">โรงเรียนเชียงคำวิทยาคม</option>
<option value="โรงเรียนฝายกวางวิทยาคม">โรงเรียนฝายกวางวิทยาคม</option>
<option value="โรงเรียนเชียงม่วนวิทยาคม">โรงเรียนเชียงม่วนวิทยาคม</option>
<option value="โรงเรียนดอกคำใต้วิทยาคม">โรงเรียนดอกคำใต้วิทยาคม</option>
<option value="โรงเรียนถ้ำปินวิทยาคม">โรงเรียนถ้ำปินวิทยาคม</option>
<option value="โรงเรียนงำเมืองวิทยาคม">โรงเรียนงำเมืองวิทยาคม</option>
<option value="โรงเรียนปงรัชดาภิเษก">โรงเรียนปงรัชดาภิเษก</option>
<option value="โรงเรียนปงพัฒนาวิทยาคม">โรงเรียนปงพัฒนาวิทยาคม</option>
<option value="โรงเรียนขุนควรวิทยาคม">โรงเรียนขุนควรวิทยาคม</option>
<option value="โรงเรียนแม่ใจวิทยาคม">โรงเรียนแม่ใจวิทยาคม</option>
<option value="โรงเรียนภูซางวิทยาคม">โรงเรียนภูซางวิทยาคม</option>
<option value="โรงเรียนดงเจนวิทยาคม">โรงเรียนดงเจนวิทยาคม</option>

          </select>
        </div>
        
        <div class="form-group">
          <label for="email">อีเมลผู้ส่ง</label>
          <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
          <label for="phone">เบอร์โทรศัพท์</label>
          <input type="tel" id="phone" name="phone" pattern="[0-9]{10}" required>
        </div>
        
        <div class="form-group">
          <label for="additionalInfo">ข้อความเพิ่มเติม</label>
          <textarea id="additionalInfo" name="additionalInfo" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="status">สถานะการส่ง</label>
          <select id="status" name="status">
            <option value="ยังไม่ได้ตรวจสอบ">ยังไม่ได้ตรวจสอบ</option>
            <option value="ตรวจสอบแล้ว">ตรวจสอบแล้ว</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ไฟล์งาน (PDF, DOC, DOCX, XLS, XLSX, JPG, JPEG, PNG)</label>
          <div class="file-upload" id="fileUploadArea">
            <p>ลากไฟล์มาวางที่นี่หรือคลิกเพื่อเลือกไฟล์</p>
            <p>รองรับสูงสุด 15 ไฟล์ (ขนาดรวมไม่เกิน 20MB)</p>
            <input type="file" id="fileInput" multiple style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          </div>
          <div class="file-preview" id="filePreview"></div>
        </div>
        
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <button type="submit" class="btn" id="submitBtn">ส่งข้อมูล</button>
      </form>
    </div>
    
    <!-- Tab 2: สถิติการอัปโหลด -->
    <div class="tab-content" id="tab2">
      <div class="stats-container">
        <div class="stat-card">
          <h3>จำนวนผู้อัปโหลด</h3>
          <div class="stat-value" id="totalUploaders">0</div>
        </div>
        <div class="stat-card">
          <h3>จำนวนไฟล์สื่อ</h3>
          <div class="stat-value" id="totalFiles">0</div>
        </div>
        <div class="stat-card">
          <h3>จำนวนข้อความ</h3>
          <div class="stat-value" id="totalMessages">0</div>
        </div>
      </div>
      
      <div class="chart-container">
        <h3>สถิติการอัปโหลดตามโรงเรียน</h3>
        <canvas id="schoolChart"></canvas>
      </div>
      
      <div class="chart-container">
        <h3>สถิติการอัปโหลดตามตำแหน่ง</h3>
        <canvas id="positionChart"></canvas>
      </div>
      
      <h3>รายการล่าสุด</h3>
      <table id="recentSubmissions">
        <thead>
          <tr>
            <th>วันที่ส่ง</th>
            <th>ชื่อ-สกุล</th>
            <th>ตำแหน่ง</th>
            <th>โรงเรียน</th>
            <th>สถานะ</th>
            <th>ภาพย่อ</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>
    
    <!-- Tab 3: จัดการข้อมูล -->
    <div class="tab-content" id="tab3">
      <h3>ข้อมูลผู้ส่ง</h3>
      <table id="dataTable">
        <thead>
          <tr>
            <th>วันที่ส่ง</th>
            <th>ชื่อ-สกุล</th>
            <th>ตำแหน่ง</th>
            <th>โรงเรียน</th>
            <th>สถานะ</th>
            <th>ภาพย่อ</th>
            <th>การจัดการ</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be loaded here -->
        </tbody>
      </table>
      
      <div style="margin-top: 20px;">
        <button class="btn" id="printReportBtn">พิมพ์รายงาน</button>
      </div>
    </div>
        <!-- Tab 4: ตรวจสอบข้อมูล -->
    <div class="tab-content" id="tab4">
      <h3>ข้อมูลผู้ส่ง</h3>
      <div style="border-radius: 8px; box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 12px; margin: auto; max-width: 100%; overflow: hidden; text-align: center;">
  <iframe src="https://developmentsesapy.github.io/Retireeinfo/show.html" style="border: 0; height: 1500px; width: 100%;">
  </iframe>
</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // PDPA Modal
    document.addEventListener('DOMContentLoaded', function() {
      const pdpaModal = document.getElementById('pdpaModal');
      const pdpaAgree = document.getElementById('pdpaAgree');
      const pdpaDisagree = document.getElementById('pdpaDisagree');
      
      // Check if user has already agreed to PDPA
      if (!localStorage.getItem('pdpaAgreed')) {
        pdpaModal.style.display = 'flex';
      } else {
        pdpaModal.style.display = 'none';
      }
      
      // Handle agreement
      pdpaAgree.addEventListener('click', function() {
        localStorage.setItem('pdpaAgreed', 'true');
        pdpaModal.style.display = 'none';
      });
      
      // Handle disagreement
      pdpaDisagree.addEventListener('click', function() {
        Swal.fire({
          title: 'คำเตือน',
          text: 'คุณจำเป็นต้องยินยอมนโยบายความเป็นส่วนตัวเพื่อใช้งานระบบ',
          icon: 'warning',
          confirmButtonText: 'เข้าใจแล้ว'
        }).then(() => {
          pdpaModal.style.display = 'flex';
        });
      });
      
      // Tab switching
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Remove active class from all tabs and tab contents
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // Add active class to clicked tab and corresponding content
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
          
          // Load data when switching to stats or management tabs
          if (tabId === 'tab2') {
            loadStatistics();
          } else if (tabId === 'tab3') {
            loadDataTable();
          }
        });
      });
      
      // File upload handling
      const fileUploadArea = document.getElementById('fileUploadArea');
      const fileInput = document.getElementById('fileInput');
      const filePreview = document.getElementById('filePreview');
      let files = [];
      
      // Handle click on upload area
      fileUploadArea.addEventListener('click', function() {
        fileInput.click();
      });
      
      // Handle file selection
      fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
      });
      
      // Handle drag and drop
      fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('active');
      });
      
      fileUploadArea.addEventListener('dragleave', function() {
        this.classList.remove('active');
      });
      
      fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('active');
        handleFiles(e.dataTransfer.files);
      });
      
      function handleFiles(newFiles) {
        // Check total file count
        if (files.length + newFiles.length > 15) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'คุณสามารถอัปโหลดได้สูงสุด 15 ไฟล์ต่อครั้ง',
            icon: 'error'
          });
          return;
        }
        
        // Check total file size
        let totalSize = files.reduce((sum, file) => sum + file.size, 0);
        for (let i = 0; i < newFiles.length; i++) {
          totalSize += newFiles[i].size;
        }
        
        if (totalSize > 20 * 1024 * 1024) { // 20MB
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'ขนาดไฟล์รวมต้องไม่เกิน 20MB',
            icon: 'error'
          });
          return;
        }
        
        // Add new files to array
        files = [...files, ...Array.from(newFiles)];
        updateFilePreview();
      }
      
      function updateFilePreview() {
        filePreview.innerHTML = '';
        
        files.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-preview-item';
          
          if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            fileItem.appendChild(img);
          } else {
            const fileIcon = document.createElement('div');
            fileIcon.style.display = 'flex';
            fileIcon.style.flexDirection = 'column';
            fileIcon.style.alignItems = 'center';
            fileIcon.style.justifyContent = 'center';
            fileIcon.style.height = '100%';
            fileIcon.style.padding = '10px';
            
            const icon = document.createElement('i');
            if (file.type.includes('pdf')) {
              icon.className = 'fas fa-file-pdf';
              icon.style.color = '#FF0000';
              icon.style.fontSize = '24px';
            } else if (file.type.includes('word') || file.type.includes('document')) {
              icon.className = 'fas fa-file-word';
              icon.style.color = '#2B579A';
              icon.style.fontSize = '24px';
            } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) {
              icon.className = 'fas fa-file-excel';
              icon.style.color = '#217346';
              icon.style.fontSize = '24px';
            } else {
              icon.className = 'fas fa-file';
              icon.style.fontSize = '24px';
            }
            
            const fileName = document.createElement('span');
            fileName.textContent = file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name;
            fileName.style.fontSize = '12px';
            fileName.style.marginTop = '5px';
            fileName.style.textAlign = 'center';
            fileName.style.wordBreak = 'break-all';
            
            fileIcon.appendChild(icon);
            fileIcon.appendChild(fileName);
            fileItem.appendChild(fileIcon);
          }
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-file';
          removeBtn.innerHTML = '&times;';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            files.splice(index, 1);
            updateFilePreview();
          });
          
          fileItem.appendChild(removeBtn);
          filePreview.appendChild(fileItem);
        });
      }
      
      // Form submission
      const uploadForm = document.getElementById('uploadForm');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      
      uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        if (!validateForm()) {
          return;
        }
        
        // Show loading
        loadingOverlay.style.display = 'flex';
        progressContainer.style.display = 'block';
        
        // Prepare form data
        const formData = {
          submissionDate: document.getElementById('submissionDate').value,
          fullName: document.getElementById('fullName').value,
          position: document.getElementById('position').value,
          academicRank: document.getElementById('academicRank').value,
          school: document.getElementById('school').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          additionalInfo: document.getElementById('additionalInfo').value,
          status: document.getElementById('status').value,
          files: []
        };
        
        // Process files if any
        if (files.length > 0) {
          const fileReaders = [];
          
          files.forEach((file, index) => {
            const reader = new FileReader();
            fileReaders.push(reader);
            
            reader.onload = function(e) {
              formData.files.push({
                name: file.name,
                type: file.type,
                data: e.target.result.split(',')[1] // Remove data URL prefix
              });
              
              // Update progress
              const progress = Math.round(((index + 1) / files.length) * 100);
              progressBar.style.width = `${progress}%`;
              progressBar.textContent = `${progress}%`;
              
              // When all files are read, submit the form
              if (formData.files.length === files.length) {
                submitForm(formData);
              }
            };
            
            reader.readAsDataURL(file);
          });
        } else {
          submitForm(formData);
        }
      });
      
      function validateForm() {
        const fullName = document.getElementById('fullName').value;
        const position = document.getElementById('position').value;
        const school = document.getElementById('school').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        
        if (!fullName) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'กรุณากรอกชื่อ-สกุล',
            icon: 'error'
          });
          return false;
        }
        
        if (!position) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'กรุณาเลือกตำแหน่ง',
            icon: 'error'
          });
          return false;
        }
        
        if (!school) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'กรุณาเลือกโรงเรียน',
            icon: 'error'
          });
          return false;
        }
        
        if (!email) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'กรุณากรอกอีเมล',
            icon: 'error'
          });
          return false;
        }
        
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'รูปแบบอีเมลไม่ถูกต้อง',
            icon: 'error'
          });
          return false;
        }
        
        if (!phone) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'กรุณากรอกเบอร์โทรศัพท์',
            icon: 'error'
          });
          return false;
        }
        
        if (!/^[0-9]{10}$/.test(phone)) {
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'เบอร์โทรศัพท์ต้องเป็นตัวเลข 10 หลัก',
            icon: 'error'
          });
          return false;
        }
        
        return true;
      }
      
      function submitForm(formData) {
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec';
        
        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify(formData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          loadingOverlay.style.display = 'none';
          
          if (data.success) {
            Swal.fire({
              title: 'สำเร็จ!',
              text: 'ข้อมูลและไฟล์ถูกส่งเรียบร้อยแล้ว',
              icon: 'success'
            }).then(() => {
              // Reset form
              uploadForm.reset();
              files = [];
              updateFilePreview();
              progressContainer.style.display = 'none';
              progressBar.style.width = '0%';
              progressBar.textContent = '0%';
              
              // Reload statistics if on that tab
              if (document.getElementById('tab2').classList.contains('active')) {
                loadStatistics();
              }
              
              // Reload data table if on that tab
              if (document.getElementById('tab3').classList.contains('active')) {
                loadDataTable();
              }
            });
          } else {
            Swal.fire({
              title: 'ข้อผิดพลาด',
              text: data.message || 'เกิดข้อผิดพลาดในการส่งข้อมูล',
              icon: 'error'
            });
          }
        })
        .catch(error => {
          loadingOverlay.style.display = 'none';
          Swal.fire({
            title: 'ข้อผิดพลาด',
            text: 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message,
            icon: 'error'
          });
        });
      }
      
      // Load statistics
      function loadStatistics() {
        showLoading();
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec?action=getStats';
        
        fetch(SCRIPT_URL)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            hideLoading();
            if (data && data.success) {
              // Update stats cards
              document.getElementById('totalUploaders').textContent = data.totalUploaders || 0;
              document.getElementById('totalFiles').textContent = data.totalFiles || 0;
              document.getElementById('totalMessages').textContent = data.totalMessages || 0;
              
              // Update recent submissions table
              const recentTableBody = document.querySelector('#recentSubmissions tbody');
              recentTableBody.innerHTML = '';
              
              if (data.recentSubmissions && data.recentSubmissions.length > 0) {
                data.recentSubmissions.forEach(submission => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${submission.date || '-'}</td>
                    <td>${submission.name || '-'}</td>
                    <td>${submission.position || '-'}</td>
                    <td>${submission.school || '-'}</td>
                    <td>${submission.status || '-'}</td>
                    <td>${
                      submission.thumbnail 
                        ? `<img src="${submission.thumbnail}" class="thumbnail-img" alt="ภาพย่อ">` 
                        : '-'
                    }</td>
                  `;
                  recentTableBody.appendChild(row);
                });
              } else {
                recentTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
              }
              
              // Create charts if data exists
              if (data.chartData) {
                createCharts(data.chartData);
              }
            } else {
              showError('ไม่สามารถโหลดสถิติได้: ' + (data ? data.message : 'ไม่มีข้อมูล'));
            }
          })
          .catch(error => {
            hideLoading();
            showError('เกิดข้อผิดพลาดในการโหลดสถิติ: ' + error.message);
          });
      }
      
      // Create charts
      function createCharts(chartData) {
        try {
          // School chart (bar chart)
          const schoolCtx = document.getElementById('schoolChart').getContext('2d');
          if (window.schoolChart) {
            window.schoolChart.destroy();
          }
          
          if (chartData.schools && chartData.schools.length > 0) {
            // เรียงลำดับข้อมูลโรงเรียนตามจำนวนจากมากไปน้อย
            const sortedSchools = [...chartData.schools].sort((a, b) => b.count - a.count);
            
            window.schoolChart = new Chart(schoolCtx, {
              type: 'bar',
              data: {
                labels: sortedSchools.map(item => item.school || 'ไม่ระบุ'),
                datasets: [{
                  label: 'จำนวนการส่ง',
                  data: sortedSchools.map(item => item.count || 0),
                  backgroundColor: '#2E7D32',
                  borderColor: '#1B5E20',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1
                    }
                  },
                  x: {
                    ticks: {
                      autoSkip: false,
                      maxRotation: 45,
                      minRotation: 45
                    }
                  }
                },
                animation: {
                  duration: 1000
                }
              }
            });
          } else {
            schoolCtx.canvas.parentNode.innerHTML = '<p>ไม่มีข้อมูลสถิติตามโรงเรียน</p>';
          }
          
          // Position chart (pie chart)
          const positionCtx = document.getElementById('positionChart').getContext('2d');
          if (window.positionChart) {
            window.positionChart.destroy();
          }
          
          if (chartData.positions && chartData.positions.length > 0) {
            window.positionChart = new Chart(positionCtx, {
              type: 'pie',
              data: {
                labels: chartData.positions.map(item => item.position || 'ไม่ระบุ'),
                datasets: [{
                  label: 'จำนวนการส่ง',
                  data: chartData.positions.map(item => item.count || 0),
                  backgroundColor: [
                    '#2E7D32',
                    '#4CAF50',
                    '#81C784',
                    '#A5D6A7',
                    '#C8E6C9',
                    '#E8F5E9'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'right',
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return `${label}: ${value} (${percentage}%)`;
                      }
                    }
                  }
                },
                animation: {
                  duration: 1000
                }
              }
            });
          } else {
            positionCtx.canvas.parentNode.innerHTML = '<p>ไม่มีข้อมูลสถิติตามตำแหน่ง</p>';
          }
        } catch (error) {
          console.error('Error creating charts:', error);
        }
      }
      
      // Load data table for management
      function loadDataTable() {
        showLoading();
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec?action=getAllData';
        
        fetch(SCRIPT_URL)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            hideLoading();
            if (data && data.success) {
              const tableBody = document.querySelector('#dataTable tbody');
              tableBody.innerHTML = '';
              
              if (data.submissions && data.submissions.length > 0) {
                data.submissions.forEach(submission => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${submission.date || '-'}</td>
                    <td>${submission.name || '-'}</td>
                    <td>${submission.position || '-'}</td>
                    <td>${submission.school || '-'}</td>
                    <td>${submission.status || '-'}</td>
                    <td>${
                      submission.thumbnail 
                        ? `<img src="${submission.thumbnail}" class="thumbnail-img" alt="ภาพย่อ">` 
                        : '-'
                    }</td>
                    <td>
                      <button class="action-btn edit-btn" data-id="${submission.id || ''}"><i class="fas fa-edit"></i></button>
                      <button class="action-btn delete-btn" data-id="${submission.id || ''}"><i class="fas fa-trash"></i></button>
                    </td>
                  `;
                  tableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                  btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editSubmission(id);
                  });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                  btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteSubmission(id);
                  });
                });
              } else {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
              }
            } else {
              showError('ไม่สามารถโหลดข้อมูลได้: ' + (data ? data.message : 'ไม่มีข้อมูล'));
            }
          })
          .catch(error => {
            hideLoading();
            showError('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message);
          });
      }
      
      // Edit submission
      function editSubmission(id) {
        Swal.fire({
          title: 'กำลังโหลดข้อมูล...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        const SCRIPT_URL = `https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec?action=getSubmission&id=${id}`;
        
        fetch(SCRIPT_URL)
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            Swal.close();
            
            if (data && data.success) {
              const submission = data.submission;
              
              Swal.fire({
                title: 'แก้ไขข้อมูล',
                html: `
                  <div class="form-group">
                    <label for="editStatus">สถานะ</label>
                    <select id="editStatus" class="swal2-input">
                      <option value="ยังไม่ได้ตรวจสอบ" ${submission.status === 'ยังไม่ได้ตรวจสอบ' ? 'selected' : ''}>ยังไม่ได้ตรวจสอบ</option>
                      <option value="ตรวจสอบแล้ว" ${submission.status === 'ตรวจสอบแล้ว' ? 'selected' : ''}>ตรวจสอบแล้ว</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin-top: 15px;">
                    <label for="editPassword">รหัสผ่านการจัดการ</label>
                    <input type="password" id="editPassword" class="swal2-input" placeholder="กรอกรหัสผ่าน" required>
                  </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                preConfirm: () => {
                  const password = document.getElementById('editPassword').value;
                  if (!password) {
                    Swal.showValidationMessage('กรุณากรอกรหัสผ่าน');
                    return false;
                  }
                  return {
                    status: document.getElementById('editStatus').value,
                    password: password
                  };
                }
              }).then(result => {
                if (result.isConfirmed) {
                  updateSubmission(id, result.value);
                }
              });
            } else {
              showError(data ? data.message : 'ไม่สามารถโหลดข้อมูลได้');
            }
          })
          .catch(error => {
            Swal.close();
            showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
          });
      }
      
      function updateSubmission(id, data) {
        showLoading();
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec';
        
        fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: JSON.stringify({
            action: 'updateSubmission',
            id: id,
            status: data.status,
            password: data.password
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          hideLoading();
          if (data && data.success) {
            Swal.fire({
              title: 'สำเร็จ!',
              text: 'ข้อมูลถูกอัปเดตเรียบร้อยแล้ว',
              icon: 'success'
            }).then(() => {
              loadDataTable();
            });
          } else {
            showError(data ? data.message : 'เกิดข้อผิดพลาดในการอัปเดตข้อมูล');
          }
        })
        .catch(error => {
          hideLoading();
          showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
        });
      }
      
      // Delete submission
      function deleteSubmission(id) {
        Swal.fire({
          title: 'คุณแน่ใจหรือไม่?',
          text: "คุณจะไม่สามารถกู้คืนข้อมูลนี้ได้!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#2E7D32',
          cancelButtonColor: '#d33',
          confirmButtonText: 'ใช่, ลบข้อมูล!',
          cancelButtonText: 'ยกเลิก',
          html: `
            <div class="form-group" style="margin-top: 15px;">
              <label for="deletePassword">รหัสผ่านการจัดการ</label>
              <input type="password" id="deletePassword" class="swal2-input" placeholder="กรอกรหัสผ่าน" required>
            </div>
          `,
          preConfirm: () => {
            const password = document.getElementById('deletePassword').value;
            if (!password) {
              Swal.showValidationMessage('กรุณากรอกรหัสผ่าน');
              return false;
            }
            return password;
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const password = result.value;
            showLoading();
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxL3uYFaFOy9l56fkyc3FTjtgFu-RwjdqwstTKvgrxkgCAx0IF66--UUUAyNmRUB5TNCg/exec';
            
            fetch(SCRIPT_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'text/plain'
              },
              body: JSON.stringify({
                action: 'deleteSubmission',
                id: id,
                password: password
              })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              hideLoading();
              if (data && data.success) {
                Swal.fire(
                  'ลบแล้ว!',
                  'ข้อมูลของคุณถูกลบเรียบร้อยแล้ว',
                  'success'
                ).then(() => {
                  loadDataTable();
                });
              } else {
                showError(data ? data.message : 'เกิดข้อผิดพลาดในการลบข้อมูล');
              }
            })
            .catch(error => {
              hideLoading();
              showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            });
          }
        });
      }
      
      // Print report
      document.getElementById('printReportBtn').addEventListener('click', function() {
        window.print();
      });
      
      // Helper functions
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      
      function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
      
      function showError(message) {
        Swal.fire({
          title: 'เกิดข้อผิดพลาด',
          text: message,
          icon: 'error'
        });
      }
      
      // Set current date as default
      const today = new Date();
      const formattedDate = today.toISOString().substr(0, 10);
      document.getElementById('submissionDate').value = formattedDate;
      
      // Load statistics if on that tab initially
      if (document.getElementById('tab2').classList.contains('active')) {
        loadStatistics();
      }
      
      // Load data table if on that tab initially
      if (document.getElementById('tab3').classList.contains('active')) {
        loadDataTable();
      }
    });
  </script>
</body>
</html>
